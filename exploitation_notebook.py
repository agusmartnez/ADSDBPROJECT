# -*- coding: utf-8 -*-
"""exploitation_notebook.ipynb

Automatically generated by Colaboratory.

Original file is located at
    https://colab.research.google.com/drive/1Vuf7l8-L1nXEyfszu5s8tL7_Ic_cgAuq

# EXPLOITATION ZONE

## Installs and imports
"""

import pandas as pd
from google.colab import drive


drive.mount('/content/gdrive')

"""## Download our data sets from Drive"""

df_atur_barcelona = pd.read_csv("./gdrive/MyDrive/ADSDB Project/landing/persistent/2. output trusted zone/atur_per_sexe_trusted.csv", index_col=0)
df_export_ine = pd.read_csv("./gdrive/MyDrive/ADSDB Project/landing/persistent/2. output trusted zone/export_ine_trusted.csv", index_col=0)
df_export_ine_education = pd.read_csv("./gdrive/MyDrive/ADSDB Project/landing/persistent/2. output trusted zone/df_export_ine_education_trusted.csv", index_col=0)

"""## Data quality processes for integration"""

# Change the Total variable of the ine dataset that originally was in thousands of people to number of people
df_export_ine.Total *= 1000

# Homogenize header and data:
df_atur_barcelona = df_atur_barcelona.rename(columns={'Number': 'Total'})
df_export_ine_education = df_export_ine_education[['Year', 'CCAA', 'Gender', 'Education_Sector', 'Rate']]

# Split the column Period of the INE dataset: 2021T3 --> 2021, 3
column = df_export_ine['Quarter'].str.split("T", n = 1, expand = True)
df_export_ine['Year']= column[0]
df_export_ine['Quarter']= column[1]

df_export_ine = df_export_ine[['Year', 'Quarter', 'CCAA', 'Gender', 'Total']]

"""Here is a small sample of the changes applied after the data quality process to the datasets:"""

df_atur_barcelona.head(n=5)

df_export_ine.head(n=5)

df_export_ine_education.head(n=5)

"""## Data integration

##### **TABLE 1**

Table 1 is formed by the merge of the table containing the unemployment data from the ine with the table containing the rate of unemployment divided for each education sector.
"""

df_export_ine_group = df_export_ine.groupby(by=['Year', 'CCAA', 'Gender']).agg({'Total': 'sum'})
df_export_ine_group = df_export_ine_group.reset_index()
df_export_ine_group['Year'] = df_export_ine_group.Year.astype('int64')

df_atur_education = df_export_ine_education.merge(df_export_ine_group, how='left', on=['Year', 'CCAA', 'Gender'])
df_atur_education = df_atur_education.rename(columns={"Total":"Total (per Year, CCAA, Gender)"})

df_atur_education[df_atur_education['Year']==2020].head(n=12)

"""##### **TABLE 2**

Table 2 is formed by the concatenation of the table containing the unemployment people of Barcelona with the table containing the unemployment data from the ine.
"""

# Group the Barcelona dataset by quarters (change column month by quarter)
df2_1 = df_atur_barcelona
month = list(df2_1.Month.unique())
df2_1['Month'] = df2_1['Month'].replace(month[0:3], '1')
df2_1['Month'] = df2_1['Month'].replace(month[3:6], '2')
df2_1['Month'] = df2_1['Month'].replace(month[6:9], '3')
df2_1['Month'] = df2_1['Month'].replace(month[9:12], '4')

df2_1 = df2_1.rename(columns={'Month': 'Quarter'})

df2_1 = df2_1.drop(df2_1[df2_1.Demmand_occupancy == 'Demanda No Aturats'].index)

df2_1 = df2_1.groupby(['Year', 'Quarter', 'Gender']).agg({'Total':'sum'})
df2_1['Zone'] = 'CataluÃ±a: Bacelona'
df2_1 = df2_1.reset_index()

df2_1 = df2_1[['Year', 'Quarter', 'Zone','Gender', 'Total']]
df2_1.head(n=5)

df2_2 = df_export_ine.rename(columns={'CCAA': 'Zone'})
df2_2.head(n=5)

df_atur_zone = pd.concat([df2_1, df2_2], axis=0)
df_atur_zone

"""##### **TABLE 3**: Original Barcelona table"""

# table 3 --> table barcelona
df_atur_barcelona.head()

"""## Save the new results

We save the results in Google Drive in the landing folder, into the `1. output exploitation zone` folder.
"""

df_atur_education.to_csv("./gdrive/MyDrive/ADSDB Project/landing/persistent/3. output exploitation zone/df_atur_education_exploitation.csv", encoding='utf-8')
df_atur_zone.to_csv("./gdrive/MyDrive/ADSDB Project/landing/persistent/3. output exploitation zone/df_atur_zone_exploitation.csv", encoding='utf-8')
df_atur_barcelona.to_csv("./gdrive/MyDrive/ADSDB Project/landing/persistent/3. output exploitation zone/df_atur_barcelona_exploitation.csv", encoding='utf-8')